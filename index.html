<script>
    async function fetchShabbatTimes() {
        try {
            // 1. Fetch the LOCALLY scraped file
            // The 'cache: "no-store"' ensures phones don't show old data
            const response = await fetch('data.json', { cache: "no-store" });
            const data = await response.json();

            // 2. Update the UI
            document.getElementById('parsha-name').innerText = "פרשת " + data.parsha;
            document.getElementById('candle-lighting').innerText = data.candles;
            document.getElementById('havdalah').innerText = data.havdalah;

            // 3. Calculate Derived Times (Mincha/Arvit)
            // We create a dummy date string to use our calculation functions
            const dummyDate = "2024-01-01T"; 
            
            // Calculate Mincha (Candles + 15m logic)
            const minchaTime = calculateMincha(data.candles);
            document.getElementById('mincha-erev').innerText = minchaTime;

            // Calculate Arvit (Havdalah - 5m logic)
            const arvitTime = calculateArvit(data.havdalah);
            document.getElementById('arvit-motzash').innerText = arvitTime;

            // Show Content
            document.getElementById('loader').style.display = 'none';
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('content').classList.add('fade-in');

        } catch (error) {
            console.error("Error loading data:", error);
            document.getElementById('parsha-name').innerText = "שגיאה בטעינה";
        }
    }

    // --- Helper Logic ---

    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return (hours * 60) + minutes;
    }

    function minutesToTime(totalMinutes) {
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        return `${h}:${m.toString().padStart(2, '0')}`;
    }

    function calculateMincha(candleTimeStr) {
        const cTime = timeToMinutes(candleTimeStr);
        let target = cTime + 15;
        let rounded = Math.ceil(target / 5) * 5;
        
        // Logic: If gap is > 18 mins, go back 5 mins
        if ((rounded - cTime) > 18) rounded -= 5;
        return minutesToTime(rounded);
    }

    function calculateArvit(havdalahTimeStr) {
        const hTime = timeToMinutes(havdalahTimeStr);
        let target = hTime - 5;
        let rounded = Math.round(target / 5) * 5;
        
        // Logic: If gap > 8 mins, push later
        if ((hTime - rounded) > 8) rounded += 5;
        return minutesToTime(rounded);
    }

    fetchShabbatTimes();
</script>